apiVersion: apps/v1
kind: Deployment
metadata:
  name: mqtt-kafka-gateway
  namespace: greenhouse
spec:
  replicas: 1
  selector: { matchLabels: { app: mqtt-kafka-gateway } }
  template:
    metadata: { labels: { app: mqtt-kafka-gateway } }
    spec:
      containers:
      - name: app
        image: ${DOCKER_REGISTRY}/mqtt-kafka-gateway:latest
        env:
        - name: MQTT_BROKER
          value: "mosquitto:1883"
        - name: KAFKA_BOOTSTRAP
          value: "kafka:9092"
        - name: KAFKA_TOPIC
          value: "sensors.raw"
        ports:
        - containerPort: 8000
---
apiVersion: v1
kind: Service
metadata:
  name: mqtt-kafka-gateway
  namespace: greenhouse
spec:
  selector:
    app: mqtt-kafka-gateway
  ports:
  - port: 8000
    targetPort: 8000
    name: http
---
# sensor processor
apiVersion: apps/v1
kind: Deployment
metadata: { name: sensor-processor, namespace: greenhouse }
spec:
  replicas: 1
  selector: { matchLabels: { app: sensor-processor } }
  template:
    metadata: { labels: { app: sensor-processor } }
    spec:
      containers:
      - name: app
        image: ${DOCKER_REGISTRY}/sensor-processor:latest
        env:
        - name: KAFKA_BOOTSTRAP
          value: "kafka:9092"
        - name: INPUT_TOPIC
          value: "sensors.raw"
        - name: OUTPUT_TOPIC
          value: "sensors.processed"
        ports: [{ containerPort: 8000 }]
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: sensor-processor
  namespace: greenhouse
spec:
  selector: { app: sensor-processor }
  ports: [{ port: 8000, targetPort: 8000 }]
---
# storage writer
apiVersion: apps/v1
kind: Deployment
metadata: { name: storage-writer, namespace: greenhouse }
spec:
  replicas: 1
  selector: { matchLabels: { app: storage-writer } }
  template:
    metadata: { labels: { app: storage-writer } }
    spec:
      containers:
      - name: app
        image: ${DOCKER_REGISTRY}/storage-writer:latest
        env:
        - name: KAFKA_BOOTSTRAP
          value: "kafka:9092"
        - name: INPUT_TOPIC
          value: "sensors.processed"
        - name: DB_HOST
          value: "postgres"
        - name: DB_USER
          value: "postgres"
        - name: DB_PASS
          value: "postgres"
        - name: DB_NAME
          value: "greenhouse"
        ports: [{ containerPort: 8000 }]
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata: { name: storage-writer, namespace: greenhouse }
spec:
  selector: { app: storage-writer }
  ports: [{ port: 8000, targetPort: 8000 }]
---
# control-service
apiVersion: apps/v1
kind: Deployment
metadata: { name: control-service, namespace: greenhouse }
spec:
  replicas: 1
  selector: { matchLabels: { app: control-service } }
  template:
    metadata: { labels: { app: control-service } }
    spec:
      containers:
      - name: app
        image: ${DOCKER_REGISTRY}/control-service:latest
        env:
        - name: KAFKA_BOOTSTRAP
          value: "kafka:9092"
        - name: INPUT_TOPIC
          value: "sensors.processed"
        - name: OUTPUT_TOPIC
          value: "actuators.commands"
        - name: MQTT_BROKER
          value: "mosquitto:1883"
        ports: [{ containerPort: 8000 }]
---
apiVersion: v1
kind: Service
metadata: { name: control-service, namespace: greenhouse }
spec:
  selector: { app: control-service }
  ports: [{ port: 8000, targetPort: 8000 }]
---
# api-gateway
apiVersion: apps/v1
kind: Deployment
metadata: { name: api-gateway, namespace: greenhouse }
spec:
  replicas: 1
  selector: { matchLabels: { app: api-gateway } }
  template:
    metadata: { labels: { app: api-gateway } }
    spec:
      containers:
      - name: app
        image: ${DOCKER_REGISTRY}/api-gateway:latest
        env:
        - name: DB_HOST
          value: "postgres"
        - name: DB_USER
          value: "postgres"
        - name: DB_PASS
          value: "postgres"
        - name: DB_NAME
          value: "greenhouse"
        ports: [{ containerPort: 8000 }]
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata: { name: api-gateway, namespace: greenhouse }
spec:
  selector: { app: api-gateway }
  ports: [{ port: 80, targetPort: 8000 }]
  type: ClusterIP
---
# load generator
apiVersion: apps/v1
kind: Deployment
metadata: { name: load-generator, namespace: greenhouse }
spec:
  replicas: 1
  selector: { matchLabels: { app: load-generator } }
  template:
    metadata: { labels: { app: load-generator } }
    spec:
      containers:
      - name: app
        image: ${DOCKER_REGISTRY}/load-generator:latest
        env:
        - name: MODE
          value: "mqtt"
        - name: MQTT_BROKER
          value: "mosquitto:1883"
        - name: SENSORS
          value: "200"
        - name: RATE_PER_SENSOR
          value: "0.2"
---
# frontend
apiVersion: apps/v1
kind: Deployment
metadata: { name: frontend, namespace: greenhouse }
spec:
  replicas: 1
  selector: { matchLabels: { app: frontend } }
  template:
    metadata: { labels: { app: frontend } }
    spec:
      containers:
      - name: app
        image: ${DOCKER_REGISTRY}/frontend:latest
        ports: [{ containerPort: 80 }]
---
apiVersion: v1
kind: Service
metadata: { name: frontend, namespace: greenhouse }
spec:
  selector: { app: frontend }
  ports: [{ port: 80, targetPort: 80 }]
  type: LoadBalancer